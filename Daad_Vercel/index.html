<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø¯Ø§Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙÙ†ÙŠØ© | Daad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-primary': '#501323', 'dark-secondary': '#3E0F1C', 'accent-gold': '#D5C5A0', 
                        'text-light': '#F2E8D8', 'highlight-green': '#10B981', 'highlight-orange': '#F59E0B', 
                        'text-contrast': '#E0D6BC', 
                    },
                    fontFamily: { sans: ['Cairo', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        :root { font-family: 'Cairo', sans-serif; }
        body { background-color: #501323; background-image: radial-gradient(circle at center, #501323 0%, #3E0F1C 100%); min-height: 100vh; background-attachment: fixed; }
        .scrollbar-thin::-webkit-scrollbar { width: 8px; height: 8px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #D5C5A0; border-radius: 10px; }
        .scrollbar-thin::-webkit-scrollbar-track { background-color: #3E0F1C; }
        input, textarea, select { background-color: #3E0F1C; color: #F2E8D8; border: 1px solid #501323; transition: border-color 0.2s; }
        input:focus, textarea:focus, select:focus { border-color: #D5C5A0; box-shadow: 0 0 0 2px rgba(213, 197, 160, 0.5); outline: none; }
        input[type="checkbox"] { -webkit-appearance: none; appearance: none; width: 1.5rem; height: 1.5rem; border: 2px solid #D5C5A0; border-radius: 0.375rem; background-color: #3E0F1C; cursor: pointer; position: relative; }
        input[type="checkbox"]:checked { background-color: #D5C5A0; border-color: #D5C5A0; }
        input[type="checkbox"]:checked::after { content: 'âœ“'; color: #501323; font-size: 1rem; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 900; }
        .logo-float { position: fixed; bottom: 20px; left: 20px; z-index: 50; cursor: pointer; border-radius: 9999px; transition: transform 0.3s, box-shadow 0.3s; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); background-color: #3E0F1C; border: 3px solid #E0D6BC; width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .logo-float:hover { transform: scale(1.05); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7); }
        .logo-float img { width: 100%; height: 100%; object-fit: contain; border-radius: 9999px; }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .chat-log { height: 450px; }
        .chat-message { max-width: 85%; word-wrap: break-word; line-height: 1.7; font-size: 0.95rem; }
        .user-message { background-color: #D5C5A0; color: #3E0F1C; align-self: flex-start; }
        .bot-message { background-color: #3E0F1C; color: #F2E8D8; border: 1px solid #501323; align-self: flex-end; }
        .bot-message ul { list-style: disc; padding-right: 20px; margin: 8px 0; }
        .bot-message strong { color: #D5C5A0; font-weight: 700; }
        .loading-dots span { width: 8px; height: 8px; background-color: #D5C5A0; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        @media print { .no-print { display: none !important; } body { background-color: #501323 !important; color: #F2E8D8 !important; -webkit-print-color-adjust: exact !important; } .print-area { width: 100%; margin: 0; padding: 20px; } .logo-float { display: none !important; } }
    </style>
</head>
<body class="text-text-light antialiased">

    <main id="home-view" class="min-h-screen w-full flex items-center justify-center p-4 transition-opacity duration-500 opacity-100">
        <div class="max-w-4xl mx-auto w-full">
            <img src="https://i.ibb.co/fz5m8DNf/imgi-102-cropped-cropped-logo-daad-2000x2000-1-1-700x700-removebg-preview.png" alt="Daad Logo" class="h-20 w-auto rounded-lg shadow-md border border-accent-gold mx-auto mb-6" onerror="this.onerror=null; this.src='https://placehold.co/100x80/501323/D5C5A0?text=DAAD';">
            <h1 class="text-4xl font-bold text-accent-gold mb-4 text-center">Ø£Ø¯Ø§Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙÙ†ÙŠØ© | Daad</h1>
            <p class="text-lg text-text-light/90 mb-12 text-center">Ø§Ø¨Ø¯Ø£ Ø¨ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div onclick="selectAssistantMode()" class="md:col-span-2 bg-accent-gold text-dark-primary p-8 rounded-xl shadow-2xl transition-all duration-300 transform hover:scale-[1.03] cursor-pointer">
                    <h2 class="text-3xl font-bold mb-3">Ø§Ù„Ø§Ø³ØªØ¹Ø§Ù†Ø© Ø¨Ù…Ø³Ø§Ø¹Ø¯ Ø¶</h2>
                    <p class="text-lg text-dark-primary/80">Ø¯Ø¹ Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ ÙŠØ­Ù„Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆÙŠÙ‚ØªØ±Ø­ Ø®Ø·Ø© Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ©.</p>
                </div>
                <div onclick="selectManualMode()" class="md:col-span-1 bg-dark-secondary text-text-light p-8 rounded-xl shadow-xl border-2 border-accent-gold/50 transition-all duration-300 transform hover:scale-[1.03] cursor-pointer">
                    <h2 class="text-3xl font-bold mb-3">Ø§Ù„Ø¨Ø¯Ø¡ ÙŠØ¯ÙˆÙŠØ§Ù‹</h2>
                    <p class="text-lg text-text-light/80">Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙˆØ§Ù„Ø£Ø´Ù‡Ø± Ø¨Ù†ÙØ³Ùƒ.</p>
                </div>
            </div>
        </div>
    </main>

    <div id="client-info-modal" class="modal-backdrop fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-[100] opacity-0 pointer-events-none hidden" onclick="closeClientInfoModal()">
        <div class="bg-dark-secondary rounded-xl shadow-2xl border border-accent-gold/50 max-w-3xl w-full p-6" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-accent-gold">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h2>
                <button onclick="closeClientInfoModal()" class="text-text-light/70 hover:text-accent-gold transition-colors">âœ•</button>
            </div>
            <form id="client-info-form" class="space-y-4 max-h-[70vh] overflow-y-auto scrollbar-thin pr-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-accent-gold mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label><input type="text" id="client-name" class="w-full p-3 rounded-lg border border-dark-primary outline-none"></div>
                    <div><label class="block text-sm font-medium text-accent-gold mb-1">Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„</label><input type="text" id="client-contact-phone" class="w-full p-3 rounded-lg border border-dark-primary outline-none"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-accent-gold mb-1">Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØ¬Ø±</label><input type="url" id="client-link" class="w-full p-3 rounded-lg border border-dark-primary outline-none"></div>
                    <div><label class="block text-sm font-medium text-accent-gold mb-1">Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø³ÙˆØ´ÙŠØ§Ù„</label><input type="text" id="client-social-links" class="w-full p-3 rounded-lg border border-dark-primary outline-none"></div>
                </div>
                <div><label class="block text-sm font-medium text-accent-gold mb-1">Ø§Ù„Ù†Ø´Ø§Ø·</label><input type="text" id="client-business-type" class="w-full p-3 rounded-lg border border-dark-primary outline-none"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-accent-gold mb-1">Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</label><input type="text" id="client-target-audience" class="w-full p-3 rounded-lg border border-dark-primary outline-none"></div>
                    <div><label class="block text-sm font-medium text-accent-gold mb-1">Ø§Ù„Ù…Ù†Ø§ÙØ³ÙŠÙ†</label><input type="text" id="client-competitors" class="w-full p-3 rounded-lg border border-dark-primary outline-none"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-accent-gold mb-1">Ø§Ù„Ù‡Ø¯Ù</label><select id="client-strategy-goal" class="w-full p-3 rounded-lg border border-dark-primary outline-none"><option value="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª">Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option><option value="Ø§Ù„ÙˆØ¹ÙŠ Ø¨Ø§Ù„Ø¹Ù„Ø§Ù…Ø©">Ø§Ù„ÙˆØ¹ÙŠ Ø¨Ø§Ù„Ø¹Ù„Ø§Ù…Ø©</option><option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option></select></div>
                    <div><label class="block text-sm font-medium text-accent-gold mb-1">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</label><select id="client-budget-range" class="w-full p-3 rounded-lg border border-dark-primary outline-none"><option value="Ù…ØªÙˆØ³Ø·Ø©">Ù…ØªÙˆØ³Ø·Ø©</option><option value="ÙƒØ¨ÙŠØ±Ø©">ÙƒØ¨ÙŠØ±Ø©</option></select></div>
                </div>
                <div><label class="block text-sm font-medium text-accent-gold mb-1">Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª</label><textarea id="client-challenges" rows="2" class="w-full p-3 rounded-lg border border-dark-primary outline-none"></textarea></div>
                <div><label class="block text-sm font-medium text-accent-gold mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="client-additional-info" rows="2" class="w-full p-3 rounded-lg border border-dark-primary outline-none"></textarea></div>
                
                <button type="button" id="save-client-info-btn" onclick="handleClientInfoSubmit()" class="bg-accent-gold hover:bg-opacity-80 text-dark-primary font-bold py-3 px-6 rounded-xl shadow-lg w-full transition duration-300">Ø­ÙØ¸ ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ø¹ Ù…Ø³Ø§Ø¹Ø¯ Ø¶</button>
            </form>
        </div>
    </div>

    <div id="ai-modal" class="modal-backdrop fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-[100] opacity-0 pointer-events-none hidden" onclick="closeAiModal()">
        <div class="bg-dark-secondary rounded-xl shadow-2xl border border-accent-gold/50 max-w-3xl w-full p-6 flex flex-col h-[85vh]" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b border-dark-primary pb-3">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-accent-gold flex items-center justify-center ml-3 text-dark-primary">ğŸ¤–</div>
                    <div><h2 class="text-xl font-bold text-accent-gold">Ù…Ø³Ø§Ø¹Ø¯ Ø¶</h2><p class="text-xs text-text-light/60">ÙƒØ¨ÙŠØ± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠÙŠÙ†</p></div>
                </div>
                <button onclick="closeAiModal()" class="text-text-light/70 hover:text-accent-gold">âœ•</button>
            </div>
            <div id="chat-log" class="chat-log w-full flex-grow bg-dark-primary/30 rounded-lg p-4 overflow-y-auto scrollbar-thin flex flex-col space-y-4 mb-4"></div>
            <div class="relative pt-2 border-t border-dark-primary">
                <textarea id="chat-input" rows="2" class="w-full p-4 pl-12 rounded-xl border border-dark-primary bg-dark-primary/50 focus:border-accent-gold outline-none resize-none" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..."></textarea>
                <button id="chat-send-btn" onclick="sendChatMessage()" class="absolute left-2 bottom-2 bg-accent-gold text-dark-primary p-2 rounded-lg hover:bg-opacity-90"><svg class="w-5 h-5 transform rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg></button>
            </div>
        </div>
    </div>

    <div id="app-view" class="min-h-screen flex flex-col print-area hidden">
        <header class="sticky top-0 bg-dark-primary shadow-2xl p-4 z-20 no-print border-b border-dark-secondary">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <img src="https://i.ibb.co/fz5m8DNf/imgi-102-cropped-cropped-logo-daad-2000x2000-1-1-700x700-removebg-preview.png" alt="Daad Logo" class="h-10 w-auto rounded-lg shadow-md border border-accent-gold" onerror="this.onerror=null; this.src='https://placehold.co/100x40/501323/D5C5A0?text=DAAD';">
                    <button onclick="openClientInfoModal()" class="bg-dark-secondary text-accent-gold font-bold py-2 px-4 rounded-xl shadow-lg text-sm">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>
                </div>
                <div class="flex space-x-3 space-x-reverse">
                    <button onclick="openAiModal()" class="bg-dark-secondary text-accent-gold font-bold py-2 px-4 rounded-xl shadow-lg text-sm">Ù…Ø³Ø§Ø¹Ø¯ Ø¶</button>
                    <button onclick="generateTechnicalProposal()" class="bg-accent-gold text-dark-primary font-bold py-2 px-4 rounded-xl shadow-lg text-sm">Ø·Ø¨Ø§Ø¹Ø©</button>
                </div>
            </div>
        </header>
        <main class="flex-grow max-w-7xl mx-auto w-full p-4">
            <div id="system-message" class="fixed top-20 right-4 bg-accent-gold text-dark-primary p-3 rounded-xl shadow-xl transition-all duration-300 opacity-0 transform translate-y-full no-print z-50"></div>
            <div id="months-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 mt-8"></div>
            <div class="flex justify-center mt-8 no-print">
                <button onclick="addNextMonth()" id="add-month-button" class="bg-highlight-green text-dark-primary font-bold py-3 px-8 rounded-xl shadow-lg">+ Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </main>
    </div>

    <a href="https://wa.me/+966592136734" target="_blank" class="logo-float no-print">
        <img src="https://i.ibb.co/fz5m8DNf/imgi-102-cropped-cropped-logo-daad-2000x2000-1-1-700x700-removebg-preview.png" onerror="this.onerror=null; this.src='https://placehold.co/70x70/501323/D5C5A0?text=DAAD';">
    </a>

    <script>
        // =================================================================
        // âš ï¸ Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹: Ø¶Ø¹ Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨ÙŠÙ† Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªÙ†ØµÙŠØµ
        // =================================================================
        const API_KEY = "AIzaSyAZcDET8R3752vyMO3EfPfKShyvYEt2_j4"; 
        
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbytnMAGBbWM_eSxUQxIqU6F7xUoxAH1P5olmGMER3YacoJRCmzX5L5_Wy4rVCLfVgsw/exec"; 

        const PROPOSAL_STORAGE_KEY = 'daad_proposal';
        const CLIENT_INFO_KEY = 'daad_client';
        const MAX_MONTHS = 12;
        let monthlySelections = [{}];
        let visibleMonths = 1;
        let chatHistory = [];
        let isAssistantMode = false;
        let services = [
            {id:'salla_zid', name:'Ø§Ù†Ø´Ø§Ø¡ Ø³Ù„Ø©/Ø²Ø¯'}, {id:'wordpress', name:'Ø§Ù†Ø´Ø§Ø¡ ÙˆÙˆØ±Ø¯Ø¨Ø±Ø³'},
            {id:'ui_ux', name:'UI/UX'}, {id:'mb', name:'Media Buying'}, {id:'seo', name:'SEO'},
            {id:'social', name:'Social Media'}, {id:'cro', name:'CRO'}, {id:'branding', name:'Branding'}
        ];
        
        const serviceCommitments = {
             'salla_zid': (i) => `<div class='service-commitment'><h2>ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø±</h2><p>ØªØ­Ù„ÙŠÙ„ ÙˆØªÙ†ÙÙŠØ° ÙˆØªØ³Ù„ÙŠÙ….</p></div>`,
             'wordpress': (i) => `<div class='service-commitment'><h2>ØªØµÙ…ÙŠÙ… Ù…ÙˆÙ‚Ø¹</h2><p>ØªØ­Ù„ÙŠÙ„ ÙˆØªÙ†ÙÙŠØ°.</p></div>`,
        };

        function loadData() {
            try {
                const saved = localStorage.getItem(PROPOSAL_STORAGE_KEY);
                if(saved) {
                    const data = JSON.parse(saved);
                    monthlySelections = data.monthlySelections || [{}];
                    visibleMonths = Math.min(monthlySelections.length, MAX_MONTHS);
                }
                const info = JSON.parse(localStorage.getItem(CLIENT_INFO_KEY) || '{}');
                if(info.name) {
                    document.getElementById('client-name').value = info.name;
                    document.getElementById('client-contact-phone').value = info.phone || '';
                    document.getElementById('client-link').value = info.link || '';
                    document.getElementById('client-business-type').value = info.businessType || '';
                    document.getElementById('client-target-audience').value = info.targetAudience || '';
                    document.getElementById('client-strategy-goal').value = info.strategyGoal || '';
                    document.getElementById('client-budget-range').value = info.budgetRange || '';
                    document.getElementById('client-competitors').value = info.competitors || '';
                    document.getElementById('client-social-links').value = info.socials || '';
                    document.getElementById('client-challenges').value = info.challenges || '';
                    document.getElementById('client-additional-info').value = info.additionalInfo || '';
                }
            } catch(e) {}
        }
        
        function renderMonthsGrid() {
            const grid = document.getElementById('months-grid');
            grid.innerHTML = '';
            for(let i=0; i<visibleMonths; i++) {
                let html = `<div class="bg-dark-secondary rounded-xl p-6 shadow-lg border border-accent-gold/30"><h2 class="text-xl font-bold text-accent-gold mb-4 border-b border-dark-primary pb-2">Ø§Ù„Ø´Ù‡Ø± ${i+1}</h2><div class="space-y-2">`;
                services.forEach(s => {
                    const checked = monthlySelections[i] && monthlySelections[i][s.id];
                    html += `<div class="flex items-center"><input type="checkbox" ${checked?'checked':''} onchange="updateSelection(${i},'${s.id}',this.checked)" class="w-5 h-5 ml-2"><span class="text-text-light">${s.name}</span></div>`;
                });
                html += `</div></div>`;
                grid.innerHTML += html;
            }
            localStorage.setItem(PROPOSAL_STORAGE_KEY, JSON.stringify({monthlySelections: monthlySelections.slice(0, visibleMonths)}));
        }

        function updateSelection(m, id, checked) {
            if(!monthlySelections[m]) monthlySelections[m] = {};
            if(checked) monthlySelections[m][id] = true; else delete monthlySelections[m][id];
            renderMonthsGrid();
        }

        function addNextMonth() { if(visibleMonths < MAX_MONTHS) { visibleMonths++; monthlySelections.push({}); renderMonthsGrid(); } }

        function getClientInfo() {
            return {
                name: document.getElementById('client-name').value,
                phone: document.getElementById('client-contact-phone').value,
                link: document.getElementById('client-link').value,
                businessType: document.getElementById('client-business-type').value,
                targetAudience: document.getElementById('client-target-audience').value,
                strategyGoal: document.getElementById('client-strategy-goal').value,
                budgetRange: document.getElementById('client-budget-range').value,
                competitors: document.getElementById('client-competitors').value,
                socials: document.getElementById('client-social-links').value,
                challenges: document.getElementById('client-challenges').value,
                additionalInfo: document.getElementById('client-additional-info').value,
                timestamp: new Date().toLocaleString()
            };
        }

        async function handleClientInfoSubmit() {
            const info = getClientInfo();
            if(!info.name) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨");
            
            localStorage.setItem(CLIENT_INFO_KEY, JSON.stringify(info));
            const btn = document.getElementById('save-client-info-btn');
            btn.disabled = true; btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

            try {
                await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(info) });
                showMessage("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!", "bg-highlight-green");
                closeClientInfoModal();
                if(isAssistantMode) setTimeout(() => openAiModal(true), 500);
            } catch(e) {
                showMessage("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹", "bg-highlight-orange");
                closeClientInfoModal();
                if(isAssistantMode) setTimeout(() => openAiModal(true), 500);
            } finally {
                btn.disabled = false; btn.textContent = 'Ø­ÙØ¸ ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ø¹ Ù…Ø³Ø§Ø¹Ø¯ Ø¶';
            }
        }

        // *** Ø¯Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Client-Side) ***
        async function callAssistant(payload) {
            try {
                if (!API_KEY || API_KEY === "Ø¶Ø¹_Ù…ÙØªØ§Ø­Ùƒ_Ù‡Ù†Ø§") {
                    return "âš ï¸ Ø®Ø·Ø£: Ù„Ù… ØªÙ‚Ù… Ø¨ÙˆØ¶Ø¹ Ù…ÙØªØ§Ø­ API ÙÙŠ ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙØªØ§Ø­.";
                }

                const systemPrompt = `
                    Ø£Ù†Øª "Ù…Ø³Ø§Ø¹Ø¯ Ø¶" (Daad Assistant)ØŒ Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ Ù„Ø´Ø±ÙƒØ© "Ø¶Ø§Ø¯".
                    Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„: ${JSON.stringify(payload.clientInfo)}
                    ØªØ­Ø¯Ø« Ø¨Ù„Ù‡Ø¬Ø© Ø³Ø¹ÙˆØ¯ÙŠØ© Ù…Ù‡Ù†ÙŠØ©.
                    ${payload.isFirstRun ? "Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„ØªØ±Ø­ÙŠØ¨." : ""}
                `;

                let contents = [{ role: "user", parts: [{ text: systemPrompt }] }];
                if (payload.history.length > 0) contents = contents.concat(payload.history.slice(-4));

                // Ø§Ø³ØªØ®Ø¯Ø§Ù… gemini-pro Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: contents })
                });

                const data = await response.json();
                if(data.error) return `âš ï¸ Ø®Ø·Ø£ Ø¬ÙˆØ¬Ù„: ${data.error.message}`;
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "ÙˆØµÙ„ Ø±Ø¯ ÙØ§Ø±Øº.";

            } catch(e) {
                return `âš ï¸ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„: ${e.message}`;
            }
        }

        async function triggerAssistantAnalysis() {
            const info = JSON.parse(localStorage.getItem(CLIENT_INFO_KEY) || '{}');
            addChatMsg("Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...", 'bot', true);
            
            const reply = await callAssistant({ history: [], clientInfo: info, isFirstRun: true });
            removeLoading();
            addChatMsg(reply, 'bot');
            if(!reply.startsWith('âš ï¸')) chatHistory.push({role: 'model', parts: [{text: reply}]});
        }

        async function sendChatMessage() {
            const txt = document.getElementById('chat-input').value;
            if(!txt) return;
            addChatMsg(txt, 'user');
            document.getElementById('chat-input').value = '';
            chatHistory.push({role: 'user', parts: [{text: txt}]});
            
            const info = JSON.parse(localStorage.getItem(CLIENT_INFO_KEY) || '{}');
            addChatMsg("...", 'bot', true);

            const reply = await callAssistant({ history: chatHistory, clientInfo: info });
            removeLoading();
            addChatMsg(reply, 'bot');
            if(!reply.startsWith('âš ï¸')) chatHistory.push({role: 'model', parts: [{text: reply}]});
        }

        function addChatMsg(txt, sender, isLoading) {
            const div = document.createElement('div');
            div.className = `chat-message p-4 rounded-xl shadow-sm mb-2 ${sender==='user'?'user-message rounded-bl-none':'bot-message rounded-br-none'}`;
            if(isLoading) {
                div.id = "loading-msg";
                div.innerHTML = `<div class="loading-dots"><span></span><span></span><span></span></div>`;
            } else {
                div.innerHTML = txt.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            }
            document.getElementById('chat-log').appendChild(div);
            document.getElementById('chat-log').scrollTop = 99999;
        }
        function removeLoading() { const l = document.getElementById('loading-msg'); if(l) l.remove(); }
        function showMessage(msg, bg) {
            const el = document.getElementById('system-message'); el.textContent = msg; el.className = `fixed top-20 right-4 p-3 rounded-xl shadow-xl z-50 ${bg}`;
            el.classList.remove('translate-y-full', 'opacity-0'); setTimeout(() => el.classList.add('translate-y-full', 'opacity-0'), 3000);
        }
        function openAiModal(auto) {
            document.getElementById('ai-modal').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
            if(!auto && document.getElementById('chat-log').children.length === 0) addChatMsg("Ø­ÙŠØ§Ùƒ Ø§Ù„Ù„Ù‡ØŒ Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ø¶.", 'bot');
            if(auto) triggerAssistantAnalysis();
        }
        function closeAiModal() { document.getElementById('ai-modal').classList.add('opacity-0', 'pointer-events-none'); setTimeout(()=>document.getElementById('ai-modal').classList.add('hidden'),300); }
        function openClientInfoModal() { document.getElementById('client-info-modal').classList.remove('hidden', 'opacity-0', 'pointer-events-none'); }
        function closeClientInfoModal() { document.getElementById('client-info-modal').classList.add('opacity-0', 'pointer-events-none'); setTimeout(()=>document.getElementById('client-info-modal').classList.add('hidden'),300); }
        function selectManualMode() { document.getElementById('home-view').classList.add('hidden'); document.getElementById('app-view').classList.remove('hidden'); }
        function selectAssistantMode() { isAssistantMode = true; selectManualMode(); openClientInfoModal(); }
        function generateTechnicalProposal() { window.print(); }

        window.onload = function() { loadData(); renderMonthsGrid(); };
    </script>
</body>
</html>
